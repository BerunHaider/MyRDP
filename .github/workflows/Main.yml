name: "âš¡ Karpux Labs - Ultimate Server"

on:
  workflow_dispatch:

jobs:
  deploy-karpux-server:
    name: "ğŸš€ Server: karpux-win-server"
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RCLONE_CONF_CONTENT: ${{ secrets.RCLONE_CONF }}
      STATIC_PASS: 'G2WP6j@n)q1{7%bE'
      HOSTNAME: "karpux-win-server"

    steps:
      - name: ğŸ“Œ Info Karpux Labs
        run: |
          Write-Host "ğŸ”¹ Iniciando Infraestructura..."
          Write-Host "ğŸ”¹ Hostname: $env:HOSTNAME"

      - name: ğŸ” Establecer Clave Fija
        run: |
          net user runneradmin $env:STATIC_PASS
          Write-Host "âœ… ContraseÃ±a establecida."

      - name: ğŸ“¥ Instalar Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
          Write-Host "âœ… Tailscale instalado."

      - name: ğŸ”— Conectar VPN
        run: |
          $env:Path += ";C:\Program Files\Tailscale"
          tailscale up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --force-reauth
          Start-Sleep -Seconds 5
          Write-Host "âœ… VPN Conectada."

      - name: â˜ï¸ Configurar Rclone
        run: |
          choco install rclone -y --no-progress
          $configPath = "$env:USERPROFILE\.config\rclone"
          New-Item -ItemType Directory -Force -Path $configPath
          Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT
          Write-Host "âœ… ConfiguraciÃ³n Drive inyectada."

      - name: ğŸ’¿ Montar Disco Z
        run: |
          Write-Host "ğŸš€ Montando Google Drive..."
          Start-Process rclone -ArgumentList "mount gdrive: Z: --vfs-cache-mode full --volname KarpuxDrive" -WindowStyle Hidden
          Write-Host "âœ… Disco Z montado en segundo plano."

      - name: ğŸ”„ Loop Servidor Activo
        run: |
          Write-Host "ğŸ‰ SERVIDOR ONLINE"
          Write-Host "ğŸ’» Hostname: $env:HOSTNAME"
          Write-Host "ğŸ“‚ Archivos en Unidad Z:"
          while ($true) { Start-Sleep -Seconds 60 }
