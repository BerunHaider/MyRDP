name: "âš¡ Karpux Labs - Ultimate Server (Fixed)"

on:
  workflow_dispatch:

jobs:
  deploy-karpux-server:
    name: "ðŸš€ Server: karpux-win-server"
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RCLONE_CONF_CONTENT: ${{ secrets.RCLONE_CONF }}
      STATIC_PASS: 'G2WP6j@n)q1{7%bE'
      HOSTNAME: "karpux-win-server"

    steps:
      - name: ðŸ“Œ Info Karpux Labs
        run: |
          Write-Host "ðŸ”¹ Iniciando Infraestructura..."
          Write-Host "ðŸ”¹ Hostname: $env:HOSTNAME"

      - name: ðŸ” Establecer Clave Fija
        run: net user runneradmin $env:STATIC_PASS

      - name: ðŸ“¥ Instalar Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait

      - name: ðŸ”— Conectar VPN
        run: |
          $env:Path += ";C:\Program Files\Tailscale"
          tailscale up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --force-reauth
          Start-Sleep -Seconds 5

      # --- CORRECCIÃ“N AQUÃ: Instalamos WinFsp ---
      - name: â˜ï¸ Configurar Rclone + WinFsp
        run: |
          Write-Host "â¬‡ï¸ Instalando Drivers..."
          choco install rclone -y --no-progress
          # ESTA ES LA CLAVE: Instalamos el driver de sistema de archivos
          choco install winfsp -y --no-progress
          
          $configPath = "$env:USERPROFILE\.config\rclone"
          New-Item -ItemType Directory -Force -Path $configPath
          Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT
          Write-Host "âœ… Drivers y ConfiguraciÃ³n listos."

      - name: ðŸ’¿ Montar Disco Z
        run: |
          Write-Host "ðŸš€ Montando Google Drive..."
          # Usamos --network-mode para asegurar que aparezca en Este Equipo
          Start-Process rclone -ArgumentList "mount gdrive: Z: --vfs-cache-mode full --volname KarpuxDrive --network-mode" -WindowStyle Hidden
          Write-Host "âœ… Disco Z montado."

      - name: ðŸ”„ Loop Servidor Activo
        run: |
          Write-Host "ðŸŽ‰ SERVIDOR ONLINE"
          Write-Host "ðŸ“‚ Revisa 'Este Equipo' > Ubicaciones de Red"
          while ($true) { Start-Sleep -Seconds 60 }
