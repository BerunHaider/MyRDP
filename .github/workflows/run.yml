name: "âš¡ Karpux Labs - Ultimate Server"

on:
  workflow_dispatch:

jobs:
  deploy-karpux-server:
    name: "ğŸš€ Server: karpux-win-server"
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Horas mÃ¡ximo

    env:
      # Secretos que ya configuraste
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RCLONE_CONF_CONTENT: ${{ secrets.RCLONE_CONF }}
      
      # Tu contraseÃ±a fija
      STATIC_PASS: 'G2WP6j@n)q1{7%bE'
      HOSTNAME: "karpux-win-server"

    steps:
      - name: ğŸ“Œ Info Karpux Labs
        run: |
          Write-Host "======================================="
          Write-Host "ğŸ”¹ Iniciando Infraestructura Karpux Labs"
          Write-Host "ğŸ”¹ Hostname: $env:HOSTNAME"
          Write-Host "======================================="

      # 1. Configurar ContraseÃ±a del Admin
      - name: ğŸ” Establecer Clave Fija
        run: |
          net user runneradmin $env:STATIC_PASS
          Write-Host "âœ… ContraseÃ±a establecida exitosamente."

      # 2. Instalar y Conectar Tailscale
      - name: ğŸ“¥ Instalar Tailscale
        run: |
          Write-Host "â¬‡ï¸ Descargando Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait

      - name: ğŸ”— Conectar VPN
        run: |
          $env:Path += ";C:\Program Files\Tailscale"
          Write-Host "ğŸ”Œ Conectando a Karpux Labs VPN..."
          # Conectamos forzando la re-autenticaciÃ³n para evitar errores
          tailscale up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --force-reauth
          Start-Sleep -Seconds 5
          Write-Host "âœ… VPN Conectada."

      # 3. Configurar Google Drive (Rclone)
      - name: â˜ï¸ Configurar Rclone
        run: |
          Write-Host "â¬‡ï¸ Instalando Rclone..."
          choco install rclone -y --no-progress
          
          # Crear carpeta y archivo de configuraciÃ³n
          $configPath = "$env:USERPROFILE\.config\rclone"
          New-Item -ItemType Directory -Force -Path $configPath
          
          # Inyectamos el secreto que creaste en el archivo
          Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT
          
          Write-Host "âœ… Credenciales de Drive instaladas."

      # 4. Montar Disco Z:
      - name: ğŸ’¿ Montar Disco Z:
        run: |
          Write-Host "ğŸš€ Conectando Google Drive como Disco Z:..."
          # Montamos el disco en segundo plano
          Start-Process rclone -ArgumentList "mount gdrive: Z: --vfs-cache-mode full --volname KarpuxDrive" -WindowStyle Hidden
          Write-Host "âœ… Disco Z: Iniciado (puede tardar unos segundos en aparecer)."

      # 5. Bucle para mantener vivo el servidor
      - name: ğŸ”„ Servidor Activo
        run: |
          Write-Host "=========================================================="
          Write-Host "ğŸ‰ SERVIDOR ONLINE - KARPUX LABS"
          Write-Host "ğŸ’» ConÃ©ctate por RDP a: $env:HOSTNAME (o la IP de Tailscale)"
          Write-Host "ğŸ‘¤ Usuario: runneradmin"
          Write-Host "ğŸ”‘ Clave  : $env:STATIC_PASS"
          Write-Host "ğŸ“‚ TU NUBE ESTÃ EN EL DISCO Z:"
          Write-Host "=========================================================="
          while ($true) { Start-Sleep -Seconds 60 }
