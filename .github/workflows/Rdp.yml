name: "âš¡ Karpux Labs - Windows Server (Static Pass)"

on:
  workflow_dispatch:

jobs:
  deploy-windows:
    name: "ğŸš€ Server: karpux-win-server"
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Horas mÃ¡ximo

    env:
      # Tu clave de Tailscale sigue estando en Secrets por seguridad
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      # AQUI ESTÃ TU CONTRASEÃ‘A FIJA
      # Usamos comillas simples '' para que GitHub no se confunda con los sÃ­mbolos % { }
      STATIC_PASS: 'G2WP6j@n)q1{7%bE'
      HOSTNAME: "karpux-win-server"

    steps:
      - name: ğŸ“Œ ConfiguraciÃ³n Inicial
        run: |
          Write-Host "==============================================="
          Write-Host "ğŸ”¹ Iniciando Infraestructura Karpux Labs"
          Write-Host "ğŸ”¹ Hostname: $env:HOSTNAME"
          Write-Host "==============================================="

      - name: ğŸ” Establecer ContraseÃ±a Fija
        run: |
          # Cambiamos la clave del admin por la tuya estÃ¡tica
          net user runneradmin $env:STATIC_PASS
          Write-Host "âœ… ContraseÃ±a establecida exitosamente: G2WP6j@n)q1{7%bE"

      - name: ğŸ“¥ Instalar Tailscale
        run: |
          Write-Host "â¬‡ï¸ Descargando Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
          
          Write-Host "âš™ï¸ Instalando..."
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait
          Write-Host "âœ… Tailscale instalado."

      - name: ğŸ”— Conectar a Tailscale
        run: |
          $env:Path += ";C:\Program Files\Tailscale"
          
          Write-Host "ğŸ”Œ Conectando a Karpux Labs VPN..."
          # Se conecta usando tu clave y fuerza el nombre del equipo
          tailscale up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --ssh --unattended
          
          $ts_ip = tailscale ip -4
          Write-Host "=========================================================="
          Write-Host "ğŸ‰ SERVIDOR ONLINE"
          Write-Host "ğŸ’» Nombre PC : $env:HOSTNAME"
          Write-Host "ğŸŒ IP Tailscale: $ts_ip"
          Write-Host "ğŸ‘¤ Usuario   : runneradmin"
          Write-Host "ğŸ”‘ Clave     : $env:STATIC_PASS"
          Write-Host "=========================================================="

      - name: ğŸ”„ Mantener Vivo
        run: |
          Write-Host "â³ Servidor activo. Esperando conexiÃ³n..."
          while ($true) {
            Start-Sleep -Seconds 60
          }
