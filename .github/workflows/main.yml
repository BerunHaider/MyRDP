name: "‚ö° Karpux Labs | Ultimate Mobile DevEnv"

on:
  workflow_dispatch:

jobs:
  deploy-ultimate-box:
    name: "üì± DevBox: ${{ github.run_id }}"
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Horas M√°ximo

    defaults:
      run:
        shell: pwsh

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RCLONE_CONF_CONTENT: ${{ secrets.RCLONE_CONF }}
      STATIC_PASS: ${{ secrets.VM_PASSWORD }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      HOSTNAME: "karpux-dev-box"
      NODE_OPTIONS: "--max_old_space_size=4096"

    steps:
      # 1. Notificaci√≥n de Inicio (Para que sepas que arranc√≥)
      - name: üîî Discord - Iniciando
        if: env.DISCORD_WEBHOOK != ''
        run: |
          $payload = @{ content = "üü° **Karpux Labs** | Iniciando despliegue de infraestructura..." }
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body ($payload | ConvertTo-Json) -ContentType 'application/json'

      # 2. Configuraci√≥n B√°sica de Red y Seguridad
      - name: üõ†Ô∏è Preparar Sistema
        run: |
          Write-Host "üîπ Configurando Admin..."
          net user runneradmin $env:STATIC_PASS /add 2>$null || net user runneradmin $env:STATIC_PASS
          
          Write-Host "üîπ Abriendo Firewall..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # 3. Instalaci√≥n Masiva de Herramientas (Optimizada)
      - name: üì¶ Instalar Herramientas (Core + DB + Utils)
        run: |
          Write-Host "‚¨áÔ∏è Instalando Pack de Ingenier√≠a..."
          # Instalamos todo en una sola l√≠nea para ahorrar tiempo
          choco install rclone winfsp mariadb cloudflared fastfetch vscode -y --no-progress --limit-output

      # 4. Configuraci√≥n de Base de Datos
      - name: üóÑÔ∏è Configurar MySQL (MariaDB)
        run: |
          Write-Host "üöÄ Iniciando Motor SQL..."
          $service = Get-Service -Name "MariaDB" -ErrorAction SilentlyContinue
          if ($service) { Start-Service "MariaDB" }
          Start-Sleep -Seconds 5
          
          Write-Host "‚öôÔ∏è Creando DB 'karpux_db'..."
          $mysqlParams = "-u root -e ""CREATE DATABASE IF NOT EXISTS karpux_db; ALTER USER 'root'@'localhost' IDENTIFIED BY 'root'; FLUSH PRIVILEGES;"""
          
          try { & mysql $mysqlParams } 
          catch { 
              $mysqlPath = Get-ChildItem -Path "C:\Program Files\MariaDB*" -Filter "mysql.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
              & $mysqlPath $mysqlParams 
          }
          Write-Host "‚úÖ DB Lista: user=root, pass=root"

      # 5. Instalaci√≥n de sampctl (Manual porque no siempre est√° en choco)
      - name: üéÆ Instalar sampctl (SAMP)
        run: |
          Invoke-WebRequest -Uri "https://github.com/Southclaws/sampctl/releases/download/1.11.0/sampctl_1.11.0_windows_amd64.zip" -OutFile "sampctl.zip"
          Expand-Archive -Path "sampctl.zip" -DestinationPath "C:\ProgramData\sampctl"
          $env:Path += ";C:\ProgramData\sampctl"
          [Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Machine)

      # 6. Conexi√≥n VPN y Montaje de Disco
      - name: ‚òÅÔ∏è Conectar Redes (Tailscale + Drive)
        run: |
          # Tailscale
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --accept-routes
          
          # Rclone
          $configPath = "$env:USERPROFILE\.config\rclone"
          New-Item -ItemType Directory -Force -Path $configPath | Out-Null
          Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT
          
          # Montaje Optimizado
          Start-Process rclone -ArgumentList "mount gdrive: Z: --volname KarpuxDrive --network-mode --vfs-cache-mode full --vfs-cache-max-size 5G" -WindowStyle Hidden
          Write-Host "‚úÖ Redes Conectadas."

      # 7. Notificaci√≥n Final y Branding
      - name: üîî Discord - Servidor Listo
        if: env.DISCORD_WEBHOOK != ''
        run: |
          # Obtenemos la IP de Tailscale
          $ip = & 'C:\Program Files\Tailscale\tailscale.exe' ip -4
          $msg = "üöÄ **Karpux Labs ONLINE** `n`nüíª **Host:** $env:HOSTNAME `nüì° **VPN IP:** $ip `nüóÑÔ∏è **MySQL:** 3306 (root/root) `n`n‚ö†Ô∏è **IMPORTANTE:** Revisa los logs de GitHub para obtener el c√≥digo de conexi√≥n de VS Code Tunnel."
          
          $payload = @{ content = $msg }
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body ($payload | ConvertTo-Json) -ContentType 'application/json'

      # 8. Loop Principal (VS Code Tunnel)
      - name: üíª INICIAR VS CODE TUNNEL
        run: |
          fastfetch --logo-color blue
          Write-Host "============================================="
          Write-Host "      ‚ö° KARPUX LABS DEV ENVIRONMENT ‚ö°      "
          Write-Host "============================================="
          Write-Host "1. Abre en tu navegador: https://github.com/login/device"
          Write-Host "2. Usa el c√≥digo que aparecer√° abajo para autorizar."
          Write-Host "3. Entra a: https://vscode.dev/tunnel/$env:HOSTNAME"
          Write-Host "============================================="
          
          # Iniciamos el t√∫nel. Esto bloquear√° el paso y mantendr√° vivo el servidor.
          code tunnel --accept-server-license-terms --name $env:HOSTNAME
