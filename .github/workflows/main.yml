name: "‚ö° Karpux Labs | Ultimate Mobile DevEnv"

on:
  workflow_dispatch:

jobs:
  deploy-ultimate-box:
    name: "üì± DevBox: ${{ github.run_id }}"
    runs-on: windows-latest
    timeout-minutes: 360 # 6 Horas M√°ximo

    defaults:
      run:
        shell: pwsh

    env:
      TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RCLONE_CONF_CONTENT: ${{ secrets.RCLONE_CONF }}
      STATIC_PASS: ${{ secrets.VM_PASSWORD }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      HOSTNAME: "karpux-dev-box"
      NODE_OPTIONS: "--max_old_space_size=4096"

    steps:
      # 1. Notificaci√≥n de Inicio
      - name: üîî Discord - Iniciando
        if: env.DISCORD_WEBHOOK != ''
        run: |
          $payload = @{ content = "üü° **Karpux Labs** | Iniciando despliegue de infraestructura..." }
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body ($payload | ConvertTo-Json) -ContentType 'application/json'

      # 2. Configuraci√≥n de Usuario y Red (VERSI√ìN POWERSHELL NATIVO)
      - name: üõ†Ô∏è Preparar Sistema
        run: |
          Write-Host "üîπ Configurando Admin (M√©todo Moderno)..."
          $user = "runneradmin"
          $securePass = ConvertTo-SecureString $env:STATIC_PASS -AsPlainText -Force

          # Crea usuario o actualiza contrase√±a sin errores interactivos
          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $user -Password $securePass -Description "Karpux Dev Admin" -PasswordNeverExpires | Out-Null
          } else {
              Set-LocalUser -Name $user -Password $securePass
          }

          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
          
          Write-Host "üîπ Abriendo Firewall..."
          try {
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0 -ErrorAction Stop
              Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
          } catch {
              Write-Host "‚ö†Ô∏è Advertencia menor en Firewall: $_"
          }

      # 3. Instalaci√≥n Masiva de Herramientas
      - name: üì¶ Instalar Herramientas (Core + DB + Utils)
        run: |
          Write-Host "‚¨áÔ∏è Instalando Pack de Ingenier√≠a..."
          choco install rclone winfsp mariadb cloudflared fastfetch vscode -y --no-progress --limit-output

      # 4. Configuraci√≥n de Base de Datos (VERSI√ìN ARRAY)
      - name: üóÑÔ∏è Configurar MySQL (MariaDB)
        run: |
          Write-Host "üöÄ Iniciando Motor SQL..."
          $service = Get-Service -Name "MariaDB" -ErrorAction SilentlyContinue
          if ($service) { Start-Service "MariaDB" }
          Start-Sleep -Seconds 5
          
          Write-Host "‚öôÔ∏è Creando DB 'karpux_db'..."
          $sqlQuery = "CREATE DATABASE IF NOT EXISTS karpux_db; ALTER USER 'root'@'localhost' IDENTIFIED BY 'root'; FLUSH PRIVILEGES;"
          $mysqlArgs = @("-u", "root", "-e", $sqlQuery)
          
          try {
              & mysql $mysqlArgs
          }
          catch {
              Write-Host "‚ö†Ô∏è Buscando ruta manual de MySQL..."
              $mysqlPath = Get-ChildItem -Path "C:\Program Files\MariaDB*" -Filter "mysql.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
              if (-not $mysqlPath) { throw "‚ùå No se encontr√≥ mysql.exe" }
              & $mysqlPath $mysqlArgs
          }
          Write-Host "‚úÖ DB Lista: user=root, pass=root"

      # 5. Instalaci√≥n de sampctl (VERSI√ìN DIN√ÅMICA - AUTO-REPARABLE)
      - name: üéÆ Instalar sampctl
        run: |
          Write-Host "üîç Consultando API de GitHub para obtener la √∫ltima versi√≥n..."
          # Obtenemos el JSON de la √∫ltima release
          $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/Southclaws/sampctl/releases/latest"
          
          # Filtramos buscando el archivo zip para Windows AMD64
          $asset = $latest.assets | Where-Object { $_.name -like "*windows_amd64.zip" } | Select-Object -First 1
          
          if (-not $asset) { throw "‚ùå No se encontr√≥ un instalador compatible en la √∫ltima versi√≥n." }
          
          Write-Host "‚¨áÔ∏è Descargando: $($asset.name)"
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "sampctl.zip"
          
          Write-Host "üì¶ Descomprimiendo..."
          Expand-Archive -Path "sampctl.zip" -DestinationPath "C:\ProgramData\sampctl" -Force
          
          $env:Path += ";C:\ProgramData\sampctl"
          [Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Machine)
          
          Write-Host "‚úÖ sampctl instalado correctamente (Versi√≥n Din√°mica)."

      # 6. Conexi√≥n VPN y Montaje de Disco
      - name: ‚òÅÔ∏è Conectar Redes (Tailscale + Drive)
        run: |
          # Tailscale
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "ts.exe"
          Start-Process -FilePath "ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$env:TS_AUTHKEY --hostname=$env:HOSTNAME --unattended --accept-routes
          
          # Rclone
          $configPath = "$env:USERPROFILE\.config\rclone"
          New-Item -ItemType Directory -Force -Path $configPath | Out-Null
          Set-Content -Path "$configPath\rclone.conf" -Value $env:RCLONE_CONF_CONTENT
          
          # Montaje
          Start-Process rclone -ArgumentList "mount gdrive: Z: --volname KarpuxDrive --network-mode --vfs-cache-mode full --vfs-cache-max-size 5G" -WindowStyle Hidden
          Write-Host "‚úÖ Redes Conectadas."

      # 7. Notificaci√≥n Final
      - name: üîî Discord - Servidor Listo
        if: env.DISCORD_WEBHOOK != ''
        run: |
          $ip = & 'C:\Program Files\Tailscale\tailscale.exe' ip -4
          $msg = "üöÄ **Karpux Labs ONLINE** `n`nüíª **Host:** $env:HOSTNAME `nüì° **VPN IP:** $ip `nüóÑÔ∏è **MySQL:** 3306 (root/root) `n`n‚ö†Ô∏è **ACCI√ìN REQUERIDA:** Revisa los logs de GitHub para obtener el c√≥digo de conexi√≥n de VS Code Tunnel."
          
          $payload = @{ content = $msg }
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body ($payload | ConvertTo-Json) -ContentType 'application/json'

      # 8. Loop Principal (VS Code Tunnel)
      - name: üíª INICIAR VS CODE TUNNEL
        run: |
          fastfetch --logo-color blue
          Write-Host "============================================="
          Write-Host "      ‚ö° KARPUX LABS DEV ENVIRONMENT ‚ö°      "
          Write-Host "============================================="
          Write-Host "1. Abre en tu navegador: https://github.com/login/device"
          Write-Host "2. Usa el c√≥digo que aparecer√° abajo para autorizar."
          Write-Host "3. Entra a: https://vscode.dev/tunnel/$env:HOSTNAME"
          Write-Host "============================================="
          
          code tunnel --accept-server-license-terms --name $env:HOSTNAME
